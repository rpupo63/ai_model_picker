"""
Interactive selection interface for AI providers and models.

Provides fuzzy-searchable dropdowns for selecting providers and models
in a terminal interface using InquirerPy.
"""

from __future__ import annotations

from typing import Optional, Tuple

from InquirerPy import inquirer
from InquirerPy.base.control import Choice

from .config import (
    get_available_providers,
    get_provider_display_name,
    get_provider_models,
)


def select_provider(prompt: str = "Select AI Provider") -> Optional[str]:
    """
    Interactively select an AI provider.

    Parameters
    ----------
    prompt : str
        The prompt to display.

    Returns
    -------
    str | None
        The selected provider key, or None if cancelled.
    """
    providers = get_available_providers()

    choices = [
        Choice(value=key, name=f"{key} - {get_provider_display_name(key)}")
        for key in providers
    ]

    try:
        return inquirer.fuzzy(
            message=prompt,
            choices=choices,
            mandatory=False,
        ).execute()
    except KeyboardInterrupt:
        return None


def select_model(
    provider: str,
    prompt: Optional[str] = None
) -> Optional[str]:
    """
    Interactively select a model for a provider.

    Parameters
    ----------
    provider : str
        The provider key.
    prompt : str | None
        Optional custom prompt. Defaults to "Select Model for {provider}".

    Returns
    -------
    str | None
        The selected model name, or None if cancelled.
    """
    if provider == "none":
        return "template"

    models = get_provider_models(provider)
    if not models:
        print(f"No models available for {provider}")
        return None

    if prompt is None:
        display_name = get_provider_display_name(provider)
        prompt = f"Select Model for {display_name}"

    try:
        return inquirer.fuzzy(
            message=prompt,
            choices=models,
            mandatory=False,
        ).execute()
    except KeyboardInterrupt:
        return None


def select_provider_and_model(
    provider_prompt: str = "Select AI Provider",
    model_prompt: Optional[str] = None
) -> Tuple[Optional[str], Optional[str]]:
    """
    Interactively select both provider and model.

    Parameters
    ----------
    provider_prompt : str
        The prompt for provider selection.
    model_prompt : str | None
        The prompt for model selection. Defaults to "Select Model for {provider}".

    Returns
    -------
    Tuple[str | None, str | None]
        Tuple of (provider, model), either may be None if cancelled.
    """
    provider = select_provider(provider_prompt)
    if not provider:
        return None, None

    model = select_model(provider, model_prompt)
    return provider, model
